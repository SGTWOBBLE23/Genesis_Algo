# GENESIS Trading Platform Architecture

## 1. Overview

The GENESIS Trading Platform is a web-based system for forex and metals trading analysis and signal management. It integrates with MetaTrader 5 (MT5) trading terminals, OANDA API for market data, and uses AI-powered chart analysis via OpenAI's Vision API to generate trading signals. The system allows users to view trading history, manage signals, and analyze technical charts.

The application follows a server-side rendered web application architecture with a Flask backend, PostgreSQL database, and Bootstrap-based frontend. It includes scheduled tasks for chart generation and analysis, and provides API endpoints for MT5 terminal integration.

## 2. System Architecture

### High-Level Architecture

The system follows a monolithic architecture organized around these main components:

1. **Web Application (Flask)** - Handles HTTP requests, renders templates, and serves as the main interface
2. **Database (PostgreSQL)** - Stores user data, signals, trades, and system settings
3. **Chart Generation System** - Creates technical analysis charts using matplotlib and mplfinance
4. **AI Vision Analysis** - Processes charts using OpenAI's Vision API to generate signals
5. **Background Workers** - Handles scheduled tasks and asynchronous processing
6. **External API Integrations** - Communicates with OANDA for market data
7. **MT5 Expert Advisor** - Client-side component that runs in MetaTrader 5 terminals

### Component Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                      Flask Web Application                       │
│                                                                 │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │ Web Routes  │  │ API Endpoints │  │ Template Rendering      │ │
│  └─────────────┘  └──────────────┘  └─────────────────────────┘ │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                      Service Layer                               │
│                                                                 │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │Signal       │  │Chart          │  │Trade                    │ │
│  │Processing   │  │Generation     │  │Management               │ │
│  └─────────────┘  └──────────────┘  └─────────────────────────┘ │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                      Data Access Layer                           │
│                                                                 │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │SQLAlchemy   │  │OANDA API     │  │File Storage             │ │
│  │Models       │  │Client        │  │(Charts)                 │ │
│  └─────────────┘  └──────────────┘  └─────────────────────────┘ │
└───────────────────────────┬─────────────────────────────────────┘
                            │
         ┌─────────────────┬──────────────────┐
         │                 │                  │
┌────────▼───────┐ ┌───────▼────────┐ ┌───────▼───────┐
│                │ │                │ │               │
│  PostgreSQL    │ │  OANDA API     │ │  OpenAI API   │
│  Database      │ │  (Market Data) │ │  (Vision)     │
│                │ │                │ │               │
└────────────────┘ └────────────────┘ └───────────────┘
```

## 3. Key Components

### 3.1 Backend (Flask)

The backend is built with Flask, a Python web framework. Key files include:
- `app.py` - Main application setup, database initialization, and model definitions
- `main.py` - Entry point and server configuration
- `mt5_ea_api.py` - API endpoints for MT5 terminal communication
- `oanda_api.py` - Client for OANDA REST API to fetch market data
- `vision_worker.py` - Handles communication with OpenAI Vision API

**Design Decision:** The use of Flask with SQLAlchemy provides a lightweight but powerful framework for building the web application. Flask's simplicity allows for rapid development while still offering the necessary flexibility for a trading platform.

### 3.2 Database

The application uses PostgreSQL with SQLAlchemy ORM for data persistence. Key models include:
- Signals - Trading signals generated by the system
- Trades - Records of executed trades from MT5
- Users - User accounts with roles and permissions
- Settings - System configuration

**Design Decision:** SQLAlchemy provides a powerful abstraction over the database, allowing for complex queries while maintaining clean code. PostgreSQL was chosen for its robustness, transaction support, and ability to handle complex financial data requirements.

### 3.3 Chart Generation

The chart generation system uses matplotlib and mplfinance to create technical analysis charts. Key files:
- `chart_generator_basic.py` - Core chart creation functionality
- `chart_utils.py` - Utilities for chart generation and manipulation
- `capture_job.py` - Scheduled job for capturing market charts

**Design Decision:** Using matplotlib/mplfinance provides complete control over chart appearance and allows for custom technical indicators. The separation between basic chart generation and utility functions promotes code reusability.

### 3.4 AI Vision Analysis

The system uses OpenAI's Vision API to analyze charts for trading opportunities:
- `vision_worker.py` - Handles sending chart images to OpenAI and processing responses
- `DirectVisionPipeline` class - Provides a streamlined workflow for chart analysis without requiring Redis

**Design Decision:** Using OpenAI's Vision API allows the platform to leverage advanced image recognition for chart pattern analysis. The direct pipeline approach was implemented as a workaround for environments where Redis might not be available.

### 3.5 MT5 Integration

The system integrates with MetaTrader 5 through a custom Expert Advisor (EA):
- `MT5_GENESIS_EA_fixed_v10.mq5` - MT5 EA that communicates with the platform
- `mt5_ea_api.py` - Server-side API endpoints for the EA to interact with

**Design Decision:** The MT5 EA provides a bridge between traders' terminals and the GENESIS platform, allowing for real-time trade data synchronization and signal execution. This architecture enables traders to continue using familiar tools while benefiting from the platform's analysis.

## 4. Data Flow

### 4.1 Chart Analysis Pipeline

1. Scheduled tasks trigger chart generation for monitored assets
2. Charts are created using historical price data from OANDA
3. Generated charts are saved to the filesystem
4. The Vision system analyzes charts using OpenAI's API
5. Analysis results are processed into trading signals
6. Signals are stored in the database and made available to users and MT5 terminals

### 4.2 Trade Synchronization

1. MT5 Expert Advisor regularly polls the platform for new signals
2. EA executes trades based on signals when conditions are met
3. Trade execution results are sent back to the platform
4. Trade history is stored in the database and displayed in the UI

### 4.3 User Interaction

1. Users access the web UI to view signals, trades, and charts
2. Settings allow users to configure risk parameters and notification preferences
3. Generated signals can be reviewed before execution
4. Historical performance is tracked and displayed

## 5. External Dependencies

### 5.1 Primary Dependencies

- **OANDA API**: Provides market data and historical prices
- **OpenAI Vision API**: Analyzes chart images for trading patterns
- **MetaTrader 5**: End-user terminal for trade execution
- **Bootstrap**: Frontend CSS framework
- **Redis** (optional): Used for task queuing between components
- **AWS S3** (optional): Alternative storage for chart images

### 5.2 Python Libraries

- **Flask**: Web framework
- **SQLAlchemy**: ORM for database interactions
- **Alembic**: Database migration tool
- **Matplotlib/mplfinance**: Chart generation
- **APScheduler**: Task scheduling
- **Pandas**: Data manipulation
- **Requests**: HTTP client for API interactions

## 6. Deployment Strategy

### 6.1 Hosting

The application is configured to run on Replit, as evidenced by the `.replit` configuration file. It uses Gunicorn as the WSGI server:

```
gunicorn --bind 0.0.0.0:5000 main:app
```

### 6.2 Database

The system uses PostgreSQL, with connection details provided via environment variables. Database migrations are managed with Alembic.

### 6.3 Worker Processes

Background tasks like chart generation and analysis are handled through scheduled jobs. Redis can optionally be used for job queuing in more complex deployments.

### 6.4 Scaling Considerations

The `.replit` file includes a deployment target of "autoscale", suggesting the application is designed to scale automatically based on load. The architecture supports horizontal scaling by adding more web nodes, though the database could become a bottleneck in high-volume scenarios.

## 7. Security Considerations

- API keys for OANDA and OpenAI are stored in environment variables
- The application uses a session secret for securing user sessions
- User roles (Admin, User, Viewer) control access to platform features
- The MT5 EA includes authentication mechanisms to ensure secure communication

## 8. Future Architectural Improvements

Based on the codebase analysis, potential architectural improvements could include:

1. Splitting the monolithic application into microservices (e.g., signal generation, chart analysis, MT5 communication)
2. Implementing proper message queuing with Redis or RabbitMQ for more robust asynchronous processing
3. Adding a proper frontend framework (React, Vue, etc.) for a more interactive user experience
4. Implementing WebSockets for real-time updates instead of polling
5. Enhancing the signal scoring system with more sophisticated ML models