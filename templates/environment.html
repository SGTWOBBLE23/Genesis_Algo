{% extends "layout.html" %}

{% block title %}Environment Switcher{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4>MT5 Genesis Environment Manager</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>Current Environment:</strong> 
                <span id="current-env" class="badge {% if is_test %}bg-warning{% else %}bg-success{% endif %} fs-6">
                    {% if is_test %}TEST{% else %}PRODUCTION{% endif %}
                </span>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5>Production Environment</h5>
                        </div>
                        <div class="card-body">
                            <p>The production environment connects to live MT5 terminals and processes real trading signals.</p>
                            <ul>
                                <li>All signals are sent to MT5</li>
                                <li>Uses the main database</li>
                                <li>Runs on port 5000</li>
                            </ul>
                        </div>
                        <div class="card-footer">
                            <button id="switch-prod" class="btn btn-success btn-lg w-100" {% if not is_test %}disabled{% endif %}>
                                Switch to Production
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-dark">
                            <h5>Test Environment</h5>
                        </div>
                        <div class="card-body">
                            <p>The test environment processes signals but does not send them to MT5 terminals. Perfect for development and testing.</p>
                            <ul>
                                <li>Signals are processed but not sent to MT5</li>
                                <li>Shares the database with production (unless configured differently)</li>
                                <li>Runs on port 5001</li>
                            </ul>
                        </div>
                        <div class="card-footer">
                            <button id="switch-test" class="btn btn-warning btn-lg w-100" {% if is_test %}disabled{% endif %}>
                                Switch to Test
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5>Environment Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="status-output" class="bg-dark text-light p-3 rounded" style="min-height: 150px; font-family: monospace;">
                                Waiting for command...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const prodButton = document.getElementById('switch-prod');
    const testButton = document.getElementById('switch-test');
    const statusOutput = document.getElementById('status-output');
    const currentEnv = document.getElementById('current-env');
    
    // Function to update status
    function updateStatus(message) {
        const timestamp = new Date().toLocaleTimeString();
        statusOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        statusOutput.scrollTop = statusOutput.scrollHeight;
    }
    
    // Switch to production
    prodButton.addEventListener('click', function() {
        updateStatus('Switching to PRODUCTION environment...');
        
        fetch('/api/switch-environment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target: 'production'
            })
        })
        .then(response => response.json())
        .then(data => {
            updateStatus(`Result: ${data.message}`);
            if (data.success) {
                prodButton.disabled = true;
                testButton.disabled = false;
                currentEnv.textContent = 'PRODUCTION';
                currentEnv.classList.remove('bg-warning');
                currentEnv.classList.add('bg-success');
                updateStatus('Please refresh the page to see production environment');
            }
        })
        .catch(error => {
            updateStatus(`Error: ${error.message}`);
        });
    });
    
    // Switch to test
    testButton.addEventListener('click', function() {
        updateStatus('Switching to TEST environment...');
        
        fetch('/api/switch-environment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target: 'test'
            })
        })
        .then(response => response.json())
        .then(data => {
            updateStatus(`Result: ${data.message}`);
            if (data.success) {
                testButton.disabled = true;
                prodButton.disabled = false;
                currentEnv.textContent = 'TEST';
                currentEnv.classList.remove('bg-success');
                currentEnv.classList.add('bg-warning');
                updateStatus('Please refresh the page to see test environment');
            }
        })
        .catch(error => {
            updateStatus(`Error: ${error.message}`);
        });
    });
});
</script>
{% endblock %}